<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ant AI - Intelligent Assistant</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Config for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'pulse-slow': 'pulseSlow 8s infinite ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            'from': { opacity: '0', transform: 'translateY(10px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            'from': { opacity: '0', transform: 'translateY(20px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseSlow: {
                            '0%, 100%': { opacity: '0.3', transform: 'scale(1)' },
                            '50%': { opacity: '0.6', transform: 'scale(1.1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Fira+Code:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b;
            color: #e2e8f0;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Utility classes */
        .glass-panel {
            background: rgba(9, 9, 11, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .message-bubble-ai {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-top-left-radius: 2px;
        }
        
        .message-bubble-user {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top-right-radius: 2px;
        }

        .suggestion-card:hover .gradient-overlay {
            opacity: 1;
        }
    </style>
</head>
<body class="flex h-screen relative selection:bg-indigo-500/30">

    <!-- Aurora Background -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-purple-500/10 rounded-full blur-[120px] animate-pulse-slow"></div>
        <div class="absolute bottom-[10%] right-[-5%] w-[30%] h-[30%] bg-blue-500/10 rounded-full blur-[100px] animate-pulse-slow delay-1000"></div>
        <div class="absolute top-[40%] left-[30%] w-[20%] h-[20%] bg-indigo-500/10 rounded-full blur-[80px] animate-pulse-slow delay-700"></div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in p-4">
        <div class="bg-[#18181b] border border-white/10 rounded-2xl w-full max-w-md shadow-2xl overflow-hidden relative">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <h2 class="text-lg font-medium text-white flex items-center gap-2">
                    <i data-lucide="sliders" class="w-4 h-4"></i> Model Configuration
                </h2>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="text-sm text-slate-400 mb-2 block">Creativity (Temperature): <span id="temp-value">0.7</span></label>
                    <input type="range" id="temp-input" min="0" max="1" step="0.1" value="0.7" class="w-full accent-indigo-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-[10px] text-slate-500 mt-1 uppercase tracking-wider">
                        <span>Precise</span>
                        <span>Balanced</span>
                        <span>Creative</span>
                    </div>
                </div>
                <div class="p-4 bg-indigo-500/10 rounded-xl border border-indigo-500/20">
                    <h3 class="text-indigo-300 text-sm font-medium mb-1 flex items-center gap-2"><i data-lucide="zap" class="w-3 h-3"></i> Current Model</h3>
                    <p class="text-xs text-indigo-200/70">You are using Gemini 2.5 Flash, optimized for speed and complex reasoning.</p>
                </div>
            </div>
            <div class="p-4 bg-black/20 text-right">
                <button onclick="saveSettings()" class="px-4 py-2 bg-white text-black font-medium text-sm rounded-lg hover:bg-slate-200 transition-colors">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-[#09090b]/80 backdrop-blur-xl border-r border-white/5 flex flex-col fixed md:relative z-30 h-full transition-transform duration-300 transform translate-x-0">
        
        <!-- Header Sidebar -->
        <div class="p-5 flex flex-col gap-4">
            <!-- Credits -->
            <div class="flex items-center justify-between p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/20">
                <div class="flex items-center gap-2">
                    <i data-lucide="coins" class="text-yellow-400 w-4 h-4"></i>
                    <span class="text-sm font-medium text-slate-200">Credits</span>
                </div>
                <span id="credits-display" class="text-sm font-bold text-white">5</span>
            </div>

            <!-- New Chat Button -->
            <div class="flex items-center gap-2">
                <button onclick="startNewChat()" class="flex-1 flex items-center justify-center gap-2 bg-white/5 hover:bg-white/10 text-slate-200 py-3 px-4 rounded-xl transition-all duration-300 border border-white/5 hover:border-white/10 group">
                    <i data-lucide="plus" class="text-slate-400 group-hover:text-white w-4 h-4 transition-colors"></i>
                    <span class="text-sm font-medium tracking-wide">New Chat</span>
                </button>
                <button onclick="toggleSidebar()" class="md:hidden p-3 bg-white/5 rounded-xl text-slate-400 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Saved Chats -->
        <div class="flex-1 overflow-y-auto px-4 py-2 space-y-1 custom-scrollbar">
            <div class="text-[10px] font-bold text-slate-600 px-3 py-2 uppercase tracking-widest mb-1">History</div>
            <div id="chats-list" class="space-y-1">
                <!-- Chats will be injected here -->
            </div>
        </div>

        <!-- Footer Sidebar -->
        <div class="p-5 border-t border-white/5 space-y-2">
            <button onclick="toggleSettings()" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 text-slate-400 hover:text-white transition-colors text-sm">
                <i data-lucide="settings" class="w-4 h-4"></i> Preferences
            </button>
            <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-white/5 transition-colors cursor-pointer group">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold shadow-lg shadow-indigo-500/20">
                    AI
                </div>
                <div class="flex flex-col">
                    <span class="text-sm font-medium text-slate-200 group-hover:text-white">User</span>
                    <span class="text-[10px] text-emerald-400 font-semibold tracking-wide flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                        ONLINE
                    </span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative h-full w-full z-10 bg-gradient-to-b from-transparent to-[#09090b]/50">
        
        <!-- Header -->
        <header class="absolute top-0 left-0 right-0 h-16 flex items-center justify-between px-6 z-20 pointer-events-none">
            <div class="flex items-center gap-4 pointer-events-auto">
                <button id="menu-btn" onclick="toggleSidebar()" class="hidden p-2 hover:bg-white/10 rounded-lg text-slate-400 transition-colors bg-black/20 backdrop-blur-md">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
                <div class="flex items-center gap-3 bg-black/20 backdrop-blur-md px-3 py-1.5 rounded-full border border-white/5">
                    <span class="text-sm font-medium text-slate-300 tracking-wide flex items-center gap-2">
                        Ant 
                        <span class="text-slate-700 mx-1">/</span> 
                        <span class="flex items-center gap-1.5 text-[10px] text-indigo-300 uppercase tracking-wider font-bold">
                            <i data-lucide="zap" class="w-3 h-3 fill-current"></i> Flash 2.5
                        </span>
                    </span>
                </div>
            </div>
        </header>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar pt-20 pb-40 px-4 scroll-smooth">
            <div class="max-w-4xl mx-auto min-h-full flex flex-col">
                <!-- Welcome Screen or Messages will be here -->
                <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center p-8 text-center animate-fade-in z-10">
                    <div class="relative mb-8 group">
                        <div class="absolute inset-0 bg-gradient-to-tr from-indigo-500 via-purple-500 to-pink-500 rounded-full blur-xl opacity-20 group-hover:opacity-40 transition-opacity duration-500"></div>
                        <div class="relative w-32 h-32 rounded-full overflow-hidden border-4 border-white/10 shadow-2xl flex items-center justify-center bg-black/20">
                            <img src="https://i.postimg.cc/N0WNRV8y/unnamed.jpg" alt="Ant Logo" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <h1 class="text-5xl font-light tracking-tight text-white mb-3">
                        Hello, I am <span class="font-semibold text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300">Ant</span>
                    </h1>
                    <p id="welcome-text" class="text-slate-400 text-lg mb-12 font-light max-w-lg leading-relaxed">
                        Your advanced intelligent assistant. What shall we build today?
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-2xl" id="suggestion-grid">
                        <!-- Suggestions injected by JS -->
                    </div>
                </div>

                <!-- Messages Container -->
                <div id="messages-list" class="flex flex-col justify-end flex-1 py-4 hidden">
                    <!-- Messages injected here -->
                </div>
                <div id="messages-end" class="h-4"></div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="absolute bottom-6 left-0 right-0 px-4 md:px-8 z-20">
            <div class="max-w-3xl mx-auto relative group">
                
                <!-- Stop / Warning / Typing Indicators -->
                <div id="status-indicator" class="absolute -top-12 left-1/2 transform -translate-x-1/2 w-full flex justify-center hidden">
                    <!-- Injected by JS -->
                </div>

                <!-- Glow -->
                <div id="input-glow" class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500/30 via-purple-500/30 to-pink-500/30 rounded-3xl blur opacity-0 transition-opacity duration-500"></div>
                
                <div class="relative bg-[#09090b]/90 backdrop-blur-2xl border border-white/10 rounded-2xl overflow-hidden flex flex-col shadow-2xl transition-all">
                    <div class="flex items-end p-2 gap-2">
                        <button class="p-3 text-slate-400 hover:text-indigo-400 hover:bg-white/5 rounded-xl transition-all duration-200 hidden sm:block">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                        
                        <textarea id="chat-input" rows="1" placeholder="Type a message..." class="flex-1 bg-transparent border-0 focus:ring-0 text-slate-200 placeholder-slate-600 resize-none py-3.5 px-2 max-h-48 min-h-[50px] leading-relaxed font-light tracking-wide text-[15px] outline-none"></textarea>

                        <div class="flex items-center gap-1 pb-0.5">
                            <button id="mic-btn" onclick="toggleMic()" class="p-2.5 rounded-xl transition-all duration-300 text-slate-400 hover:text-white hover:bg-white/5">
                                <i data-lucide="mic" class="w-5 h-5"></i>
                            </button>

                            <button id="send-btn" onclick="handleSendClick()" class="p-2.5 rounded-xl transition-all duration-300 flex items-center justify-center bg-white/5 text-slate-600 cursor-not-allowed" disabled>
                                <i data-lucide="send" class="w-4 h-4 ml-0.5 stroke-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3 flex justify-center items-center gap-4 text-[10px] text-slate-600 font-medium tracking-wide">
                    <span>Ant AI v2.5</span>
                    <span>•</span>
                    <span id="char-count">0 chars</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Application Logic -->
    <script>
        // --- Configuration & Constants ---
        const AI_NAME = "Ant";
        const USER_NAME = "User";
        const LOGO_URL = "https://i.postimg.cc/N0WNRV8y/unnamed.jpg";
        const apiKey = "AIzaSyBSzYdNEvp0QPyIuHNxvHLKpzhjY-xn8mc"; // API Key

        // --- State ---
        let state = {
            messages: [],
            credits: 5,
            savedChats: [],
            currentChatId: null,
            creativity: 0.7,
            isTyping: false,
            isListening: false,
            abortController: null,
            input: ""
        };

        // --- DOM Elements ---
        const els = {
            sidebar: document.getElementById('sidebar'),
            menuBtn: document.getElementById('menu-btn'),
            creditsDisplay: document.getElementById('credits-display'),
            chatsList: document.getElementById('chats-list'),
            settingsModal: document.getElementById('settings-modal'),
            tempInput: document.getElementById('temp-input'),
            tempValue: document.getElementById('temp-value'),
            welcomeScreen: document.getElementById('welcome-screen'),
            welcomeText: document.getElementById('welcome-text'),
            messagesList: document.getElementById('messages-list'),
            messagesEnd: document.getElementById('messages-end'),
            chatInput: document.getElementById('chat-input'),
            sendBtn: document.getElementById('send-btn'),
            micBtn: document.getElementById('mic-btn'),
            inputGlow: document.getElementById('input-glow'),
            charCount: document.getElementById('char-count'),
            statusIndicator: document.getElementById('status-indicator'),
            suggestionGrid: document.getElementById('suggestion-grid'),
            container: document.getElementById('chat-container')
        };

        // --- Initialization ---
        function init() {
            // Load from LocalStorage
            const savedCredits = localStorage.getItem('lumina_credits');
            if (savedCredits !== null) state.credits = parseInt(savedCredits);

            const savedChats = localStorage.getItem('lumina_chats');
            if (savedChats) state.savedChats = JSON.parse(savedChats);

            // Setup Event Listeners
            els.chatInput.addEventListener('input', handleInput);
            els.chatInput.addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            els.tempInput.addEventListener('input', (e) => {
                state.creativity = parseFloat(e.target.value);
                els.tempValue.textContent = state.creativity;
            });

            // Initial Render
            renderCredits();
            renderSidebar();
            renderWelcome();
            updateInputUI();
            checkMobile();
            
            // Initial Icon Render
            lucide.createIcons();

            window.addEventListener('resize', checkMobile);
        }

        // --- Core Logic ---

        function saveState() {
            localStorage.setItem('lumina_credits', state.credits.toString());
            localStorage.setItem('lumina_chats', JSON.stringify(state.savedChats));
            renderCredits();
        }

        async function generateResponse(history) {
            state.isTyping = true;
            updateStatusIndicator();
            updateInputUI();

            state.abortController = new AbortController();
            
            const apiContents = history.map(msg => ({
                role: msg.role === 'ai' ? 'model' : msg.role,
                parts: [{ text: msg.content }]
            }));

            const systemPrompt = `You are Ant, a sophisticated and helpful AI. 
            MANDATORY FORMATTING INSTRUCTIONS:
            1. Use MARKDOWN FORMAT to structure your response.
            2. Use **bold** to highlight keywords, important concepts, or conclusions.
            3. Use CODE BLOCKS (with triple backticks and language) for any code.
            4. Use numbered lists (1. ) or bullets (- ) for step-by-step instructions.
            5. Be concise but complete.`;

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        signal: state.abortController.signal,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: apiContents,
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: {
                                temperature: state.creativity,
                                maxOutputTokens: 2000,
                            }
                        })
                    }
                );

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || 'API Error');

                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
                
                // Add placeholder message
                const aiMsgId = Date.now();
                const aiMsg = {
                    id: aiMsgId,
                    role: 'ai',
                    content: '',
                    timestamp: new Date().toISOString(),
                    isTyping: true
                };
                state.messages.push(aiMsg);
                renderMessages(); // Initial empty bubble

                // Typing Effect
                let currentText = '';
                const chars = aiText.split('');
                const chunkSize = 4;
                let i = 0;

                const typeInterval = setInterval(() => {
                    if (state.abortController.signal.aborted) {
                        clearInterval(typeInterval);
                        return;
                    }

                    if (i < chars.length) {
                        currentText += chars.slice(i, i + chunkSize).join('');
                        i += chunkSize;
                        
                        // Update last message
                        state.messages[state.messages.length - 1].content = currentText;
                        updateLastMessageBubble(currentText, true);
                        scrollToBottom();
                    } else {
                        clearInterval(typeInterval);
                        finalizeResponse(aiText);
                    }
                }, 10);

            } catch (error) {
                if (error.name === 'AbortError') return;
                console.error("Error:", error);
                
                const errorMsg = {
                    id: Date.now(),
                    role: 'ai',
                    content: 'Connection error. Please try again.',
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
                state.messages.push(errorMsg);
                state.isTyping = false;
                updateStatusIndicator();
                updateInputUI();
                renderMessages();
                saveChatHistory();
            }
        }

        function finalizeResponse(fullText) {
            state.messages[state.messages.length - 1].content = fullText;
            state.messages[state.messages.length - 1].isTyping = false;
            state.isTyping = false;
            state.abortController = null;
            
            updateLastMessageBubble(fullText, false);
            updateStatusIndicator();
            updateInputUI();
            saveChatHistory();
            scrollToBottom();
        }

        function stopGeneration() {
            if (state.abortController) {
                state.abortController.abort();
                state.abortController = null;
                
                const lastMsg = state.messages[state.messages.length - 1];
                if(lastMsg.role === 'ai' && lastMsg.isTyping) {
                    lastMsg.content += ' [Stopped]';
                    lastMsg.isTyping = false;
                    updateLastMessageBubble(lastMsg.content, false);
                }
                
                state.isTyping = false;
                updateStatusIndicator();
                updateInputUI();
                saveChatHistory();
            }
        }

        async function sendMessage() {
            const text = state.input.trim();
            if (!text || state.isTyping) return;
            
            if (state.credits <= 0) {
                alert("You have run out of credits!");
                return;
            }

            state.credits--;
            saveState();

            // Add User Message
            const userMsg = {
                id: Date.now(),
                role: 'user',
                content: text,
                timestamp: new Date().toISOString()
            };
            
            // Handle Chat ID creation
            if (!state.currentChatId) {
                state.currentChatId = Date.now();
                const newChat = {
                    id: state.currentChatId,
                    title: text.length > 30 ? text.substring(0, 30) + "..." : text,
                    timestamp: new Date().toISOString(),
                    messages: [userMsg]
                };
                state.savedChats.unshift(newChat);
                renderSidebar();
            }

            state.messages.push(userMsg);
            state.input = "";
            els.chatInput.value = "";
            handleInput(); // Reset height
            
            renderMessages();
            await generateResponse(state.messages);
        }

        function saveChatHistory() {
            if (!state.currentChatId) return;
            
            const chatIndex = state.savedChats.findIndex(c => c.id === state.currentChatId);
            if (chatIndex !== -1) {
                state.savedChats[chatIndex].messages = [...state.messages];
                // Move to top
                const chat = state.savedChats.splice(chatIndex, 1)[0];
                state.savedChats.unshift(chat);
                saveState();
                renderSidebar(); // Re-render order
            }
        }

        // --- Rendering Logic ---

        function renderCredits() {
            els.creditsDisplay.textContent = state.credits;
            els.creditsDisplay.className = `text-sm font-bold ${state.credits === 0 ? 'text-red-400' : 'text-white'}`;
            
            // Update Welcome Screen text if visible
            if(state.messages.length === 0) renderWelcome();
            updateStatusIndicator(); // Update warning if 0 credits
        }

        function renderSidebar() {
            els.chatsList.innerHTML = '';
            
            if (state.savedChats.length === 0) {
                els.chatsList.innerHTML = `<div class="text-center py-10 px-4"><p class="text-xs text-slate-600 italic">No saved chats.</p></div>`;
                return;
            }

            state.savedChats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `w-full flex items-center gap-3 p-3 rounded-lg text-left group transition-all duration-200 cursor-pointer border border-transparent ${isActive ? 'bg-indigo-500/10 border-indigo-500/20' : 'hover:bg-white/5'}`;
                div.onclick = () => loadChat(chat.id);
                
                div.innerHTML = `
                    <i data-lucide="message-square" class="w-4 h-4 ${isActive ? 'text-indigo-400' : 'text-slate-600 group-hover:text-slate-400'}"></i>
                    <div class="flex-1 overflow-hidden">
                        <span class="text-sm block truncate font-light tracking-wide ${isActive ? 'text-indigo-100' : 'text-slate-400 group-hover:text-slate-200'}">${chat.title}</span>
                    </div>
                    <button class="delete-chat-btn p-1.5 text-slate-600 hover:text-red-400 hover:bg-red-400/10 rounded opacity-0 group-hover:opacity-100 transition-all">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    </button>
                `;

                // Delete handler
                div.querySelector('.delete-chat-btn').onclick = (e) => {
                    e.stopPropagation();
                    deleteChat(chat.id);
                };

                els.chatsList.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderWelcome() {
            if (state.credits > 0) {
                els.welcomeText.textContent = "Your advanced intelligent assistant. What shall we build today?";
            } else {
                els.welcomeText.textContent = "You have run out of credits. Please reload to continue.";
            }

            // Suggestions
            const suggestions = [
                { icon: 'code', text: 'Generate a Python script' },
                { icon: 'cpu', text: 'Explain recursion' },
                { icon: 'zap', text: 'Idea for a Viral App' },
                { icon: 'message-square', text: 'Write a formal email' }
            ];

            els.suggestionGrid.innerHTML = '';
            suggestions.forEach(s => {
                const btn = document.createElement('button');
                const disabledClass = state.credits <= 0 ? 'bg-white/5 border-white/5 opacity-50 cursor-not-allowed' : 'bg-white/5 hover:bg-white/10 border-white/5 hover:border-white/10 cursor-pointer suggestion-card';
                btn.className = `group relative flex items-center gap-4 p-4 rounded-2xl border transition-all duration-300 backdrop-blur-sm text-left w-full overflow-hidden ${disabledClass}`;
                if (state.credits > 0) btn.onclick = () => { els.chatInput.value = s.text; handleInput(); sendMessage(); };
                
                btn.innerHTML = `
                    <div class="gradient-overlay absolute inset-0 bg-gradient-to-r from-purple-500/10 to-blue-500/10 opacity-0 transition-opacity duration-500"></div>
                    <div class="relative p-2 rounded-xl bg-black/20 text-slate-400 group-hover:text-white transition-colors">
                        <i data-lucide="${s.icon}" class="w-4 h-4"></i>
                    </div>
                    <span class="relative text-sm text-slate-300 group-hover:text-white font-medium transition-colors line-clamp-1">${s.text}</span>
                    ${state.credits > 0 ? `<i data-lucide="chevron-right" class="absolute right-4 text-slate-600 group-hover:text-slate-400 opacity-0 group-hover:opacity-100 transition-all transform -translate-x-2 group-hover:translate-x-0 w-4 h-4"></i>` : ''}
                `;
                els.suggestionGrid.appendChild(btn);
            });
            lucide.createIcons();
        }

        function renderMessages() {
            if (state.messages.length === 0) {
                els.welcomeScreen.classList.remove('hidden');
                els.messagesList.classList.add('hidden');
            } else {
                els.welcomeScreen.classList.add('hidden');
                els.messagesList.classList.remove('hidden');
            }

            els.messagesList.innerHTML = '';
            
            state.messages.forEach((msg, index) => {
                const isAi = msg.role === 'ai';
                const div = document.createElement('div');
                div.className = `group flex w-full ${isAi ? 'justify-start' : 'justify-end'} mb-6 animate-slide-up`;
                div.id = `msg-${msg.id}`; // Add ID for updating
                
                let contentHtml = isAi ? formatMarkdown(msg.content) : `<p class="leading-relaxed whitespace-pre-wrap">${escapeHtml(msg.content)}</p>`;
                
                // Typing Indicator logic for last message
                if (isAi && msg.isTyping) {
                    // Logic handled in loop update
                }

                div.innerHTML = `
                    <div class="flex max-w-[95%] md:max-w-[85%] lg:max-w-[75%] gap-4 ${isAi ? 'flex-row' : 'flex-row-reverse'}">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full overflow-hidden flex items-center justify-center mt-1 ${isAi ? 'bg-transparent' : 'bg-slate-700/50 text-slate-300'} ${!isAi ? 'border border-white/5 shadow-sm' : ''}">
                            ${isAi ? `<img src="${LOGO_URL}" alt="Ant" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-4 h-4"></i>`}
                        </div>
                        <div class="flex flex-col ${isAi ? 'items-start' : 'items-end'} w-full min-w-0">
                            <div class="flex items-center gap-2 mb-1.5 opacity-60 px-1">
                                <span class="text-xs font-medium text-slate-300 tracking-wide">${isAi ? AI_NAME : USER_NAME}</span>
                                <span class="text-[10px] text-slate-500">${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>
                            <div class="message-content relative px-6 py-4 rounded-2xl text-[15px] shadow-sm backdrop-blur-md w-full overflow-hidden ${isAi ? 'message-bubble-ai text-slate-200' : 'message-bubble-user text-white'}">
                                ${contentHtml}
                                ${msg.error ? `<div class="mt-2 text-red-400 text-sm flex items-center gap-2 bg-red-500/10 p-2 rounded-lg border border-red-500/20"><i data-lucide="zap" class="w-3.5 h-3.5"></i> ${msg.error}</div>` : ''}
                            </div>
                             <div class="mt-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 items-center px-1 ${isAi ? 'justify-start' : 'justify-end'}">
                                <button onclick="copyToClipboard('${msg.content.replace(/'/g, "\\'")}')" class="p-1.5 text-slate-500 hover:text-white transition-colors rounded hover:bg-white/5" title="Copy"><i data-lucide="copy" class="w-3.5 h-3.5"></i></button>
                                ${isAi && index === state.messages.length - 1 && !state.isTyping ? `<button onclick="regenerateLast()" class="p-1.5 text-slate-500 hover:text-indigo-400 transition-colors rounded hover:bg-white/5" title="Regenerate"><i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i></button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                els.messagesList.appendChild(div);
            });
            lucide.createIcons();
            scrollToBottom();
        }

        // Optimized update for typing effect (avoids re-rendering whole list)
        function updateLastMessageBubble(content, isTyping) {
            const lastMsgEl = els.messagesList.lastElementChild;
            if (!lastMsgEl) return;
            
            const contentEl = lastMsgEl.querySelector('.message-content');
            if (contentEl) {
                let html = formatMarkdown(content);
                if (isTyping) {
                    html += `<span class="inline-flex mt-2 gap-1 h-4 items-center ml-2"><span class="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-bounce"></span><span class="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-bounce" style="animation-delay: 0.075s"></span><span class="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-bounce" style="animation-delay: 0.15s"></span></span>`;
                }
                contentEl.innerHTML = html;
                // Re-init copy buttons within code blocks
                // Logic simpler: just re-render is safer for vanilla JS event bindings
            }
        }

        // --- Helpers ---

        function handleInput() {
            state.input = els.chatInput.value;
            els.chatInput.style.height = 'auto';
            els.chatInput.style.height = Math.min(els.chatInput.scrollHeight, 192) + 'px';
            
            els.charCount.textContent = `${state.input.length} chars`;
            
            if (state.input.trim() || state.isTyping) {
                els.inputGlow.classList.add('opacity-100');
            } else {
                els.inputGlow.classList.remove('opacity-100');
            }
            updateInputUI();
        }

        function updateInputUI() {
            if (state.isTyping) {
                els.sendBtn.innerHTML = `<i data-lucide="square" class="w-4 h-4 fill-current"></i>`;
                els.sendBtn.className = "p-2.5 rounded-xl transition-all duration-300 flex items-center justify-center bg-slate-100 text-slate-900 hover:bg-white shadow-lg hover:scale-105 cursor-pointer";
                els.sendBtn.onclick = handleStopClick;
            } else {
                els.sendBtn.innerHTML = `<i data-lucide="send" class="w-4 h-4 ml-0.5 stroke-2"></i>`;
                els.sendBtn.onclick = handleSendClick;
                
                if (state.input.trim() && state.credits > 0) {
                    els.sendBtn.className = "p-2.5 rounded-xl transition-all duration-300 flex items-center justify-center bg-slate-100 text-slate-900 hover:bg-white shadow-lg hover:scale-105 cursor-pointer";
                    els.sendBtn.disabled = false;
                } else {
                    els.sendBtn.className = "p-2.5 rounded-xl transition-all duration-300 flex items-center justify-center bg-white/5 text-slate-600 cursor-not-allowed";
                    els.sendBtn.disabled = true;
                }
            }
            lucide.createIcons();
        }

        function updateStatusIndicator() {
            els.statusIndicator.innerHTML = '';
            els.statusIndicator.classList.add('hidden');

            if (state.isTyping) {
                els.statusIndicator.classList.remove('hidden');
                els.statusIndicator.innerHTML = `
                    <button onclick="stopGeneration()" class="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-full text-xs font-medium shadow-xl border border-white/10 hover:bg-slate-700 transition-colors animate-fade-in">
                        <i data-lucide="square" class="w-3 h-3 fill-current"></i> Stop generation
                    </button>
                `;
            } else if (state.credits <= 0) {
                els.statusIndicator.classList.remove('hidden');
                els.statusIndicator.innerHTML = `
                    <div class="bg-red-500/10 border border-red-500/20 text-red-200 px-4 py-2 rounded-xl text-xs font-medium shadow-xl text-center backdrop-blur-md">
                        ⚠️ You have run out of credits.
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function startNewChat() {
            state.messages = [];
            state.currentChatId = null;
            state.input = "";
            els.chatInput.value = "";
            handleInput();
            renderMessages();
            renderSidebar(); // Update highlighting
            if (window.innerWidth < 768) toggleSidebar();
        }

        function loadChat(id) {
            const chat = state.savedChats.find(c => c.id === id);
            if (chat) {
                state.messages = chat.messages;
                state.currentChatId = id;
                renderMessages();
                renderSidebar();
                if (window.innerWidth < 768) toggleSidebar();
            }
        }

        function deleteChat(id) {
            if(confirm("Delete this chat permanently?")) {
                state.savedChats = state.savedChats.filter(c => c.id !== id);
                if (state.currentChatId === id) startNewChat();
                saveState();
                renderSidebar();
            }
        }

        function regenerateLast() {
            if (state.credits <= 0) {
                alert("You need credits to regenerate.");
                return;
            }
            state.credits--;
            saveState();

            // Find last user message index
            let lastUserIdx = -1;
            for(let i=state.messages.length-1; i>=0; i--){
                if(state.messages[i].role === 'user') {
                    lastUserIdx = i;
                    break;
                }
            }

            if(lastUserIdx !== -1) {
                state.messages = state.messages.slice(0, lastUserIdx + 1);
                renderMessages();
                generateResponse(state.messages);
            }
        }

        // --- Event Wrappers ---
        function handleSendClick() { sendMessage(); }
        function handleStopClick() { stopGeneration(); }
        
        function toggleSettings() {
            els.settingsModal.classList.toggle('hidden');
        }
        function saveSettings() {
            toggleSettings();
        }

        function toggleSidebar() {
            els.sidebar.classList.toggle('-translate-x-full');
            els.sidebar.classList.toggle('w-0');
            els.sidebar.classList.toggle('opacity-0');
            els.menuBtn.classList.toggle('hidden');
        }

        function checkMobile() {
            if (window.innerWidth < 768) {
                els.sidebar.classList.add('-translate-x-full', 'w-0', 'opacity-0');
                els.menuBtn.classList.remove('hidden');
            } else {
                els.sidebar.classList.remove('-translate-x-full', 'w-0', 'opacity-0');
                els.menuBtn.classList.add('hidden');
            }
        }

        // --- Speech Recognition ---
        let recognition = null;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                els.chatInput.value = (els.chatInput.value + (els.chatInput.value ? " " : "") + transcript);
                handleInput();
            };
            
            recognition.onend = () => { state.isListening = false; updateMicUI(); };
            recognition.onerror = () => { state.isListening = false; updateMicUI(); };
        }

        function toggleMic() {
            if (!recognition) {
                alert("Speech recognition not supported.");
                return;
            }
            if (state.credits <= 0) {
                alert("No credits.");
                return;
            }

            if (state.isListening) {
                recognition.stop();
                state.isListening = false;
            } else {
                recognition.start();
                state.isListening = true;
            }
            updateMicUI();
        }

        function updateMicUI() {
            if (state.isListening) {
                els.micBtn.className = "p-2.5 rounded-xl transition-all duration-300 bg-red-500/20 text-red-400";
                els.micBtn.innerHTML = `<i data-lucide="volume-2" class="w-5 h-5 animate-bounce"></i>`;
                els.chatInput.placeholder = "Listening...";
            } else {
                els.micBtn.className = "p-2.5 rounded-xl transition-all duration-300 text-slate-400 hover:text-white hover:bg-white/5";
                els.micBtn.innerHTML = `<i data-lucide="mic" class="w-5 h-5"></i>`;
                els.chatInput.placeholder = "Type a message...";
            }
            lucide.createIcons();
        }

        function scrollToBottom() {
            els.messagesEnd.scrollIntoView({ behavior: 'smooth' });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
        }

        // --- Markdown & Formatting ---
        
        function escapeHtml(text) {
            if(!text) return "";
            return text.replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
        }

        function formatMarkdown(text) {
            if (!text) return "";
            
            // 1. Code Blocks
            const parts = text.split(/```(\w*)\n([\s\S]*?)```/g);
            let html = '<div class="space-y-3 w-full">';

            parts.forEach((part, index) => {
                if (index % 3 === 2) {
                    const lang = parts[index - 1] || 'text';
                    const code = part.trim();
                    const escapedCode = escapeHtml(code);
                    
                    // Simple Highlight Simulation
                    let coloredCode = escapedCode
                        .replace(/\b(const|let|var|function|return|if|else|for|while|import|class)\b/g, '<span class="text-purple-400 font-semibold">$1</span>')
                        .replace(/\b(true|false|null|undefined)\b/g, '<span class="text-orange-400">$1</span>')
                        .replace(/(\/\/.*)/g, '<span class="text-slate-500 italic">$1</span>');

                    html += `
                        <div class="my-4 rounded-xl overflow-hidden border border-white/10 bg-[#0d1117] shadow-2xl group font-sans">
                            <div class="flex items-center justify-between px-4 py-2 bg-white/5 border-b border-white/5">
                                <div class="flex items-center gap-2">
                                    <div class="flex gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-red-500/50"></div><div class="w-2.5 h-2.5 rounded-full bg-yellow-500/50"></div><div class="w-2.5 h-2.5 rounded-full bg-green-500/50"></div></div>
                                    <span class="text-xs font-mono text-slate-400 lowercase ml-2">${lang}</span>
                                </div>
                                <button onclick="copyToClipboard('${code.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')" class="flex items-center gap-1.5 text-xs text-slate-400 hover:text-white bg-white/5 px-2 py-1 rounded-md">
                                    <i data-lucide="copy" class="w-3 h-3"></i> Copy
                                </button>
                            </div>
                            <div class="p-4 overflow-x-auto custom-scrollbar">
                                <pre class="text-sm font-mono text-slate-300 leading-relaxed whitespace-pre"><code>${coloredCode}</code></pre>
                            </div>
                        </div>
                    `;
                } else if (index % 3 === 0) {
                    // Text Parts
                    if (!part.trim()) return;
                    
                    const lines = part.split('\n');
                    lines.forEach(line => {
                        if(!line.trim()) return;
                        
                        // Bullets
                        if (line.trim().match(/^- /)) {
                            html += `<div class="flex gap-3 ml-1 mb-1"><span class="text-indigo-400 font-bold mt-1.5">•</span><span class="text-slate-300 leading-relaxed">${formatInline(line.replace(/^- /, ''))}</span></div>`;
                            return;
                        }
                        // Numbered
                        const numMatch = line.trim().match(/^(\d+)\. (.*)/);
                        if (numMatch) {
                            html += `<div class="flex gap-3 ml-1 mb-1"><span class="text-indigo-400 font-mono font-bold text-xs mt-1.5">${numMatch[1]}.</span><span class="text-slate-300 leading-relaxed">${formatInline(numMatch[2])}</span></div>`;
                            return;
                        }
                        // Headers
                        if (line.trim().startsWith('### ')) {
                            html += `<h3 class="text-lg font-semibold text-white mt-5 mb-2 border-b border-white/10 pb-1">${escapeHtml(line.substring(4))}</h3>`;
                            return;
                        }
                        if (line.trim().startsWith('## ')) {
                            html += `<h2 class="text-xl font-bold text-indigo-200 mt-6 mb-3">${escapeHtml(line.substring(3))}</h2>`;
                            return;
                        }

                        // Paragraph
                        html += `<p class="text-slate-300 leading-relaxed mb-1">${formatInline(line)}</p>`;
                    });
                }
            });

            html += '</div>';
            return html;
        }

        function formatInline(text) {
            return escapeHtml(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="text-indigo-200">$1</em>')
                .replace(/`([^`]+)`/g, '<code class="bg-indigo-500/10 px-1.5 py-0.5 rounded text-indigo-300 font-mono text-xs border border-indigo-500/20">$1</code>');
        }

        // Run Init
        init();

    </script>
</body>
</html>